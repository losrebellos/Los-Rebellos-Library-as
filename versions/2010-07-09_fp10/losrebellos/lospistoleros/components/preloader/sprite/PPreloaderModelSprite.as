package losrebellos.lospistoleros.components.preloader.sprite {	import br.com.stimuli.loading.BulkLoader;	import br.com.stimuli.loading.BulkProgressEvent;	import losrebellos.console.Console;	import losrebellos.lospistoleros.components.application.sprite.deeplinking.PApplicationSprite;	import losrebellos.lospistoleros.constants.PConstants;	import losrebellos.lospistoleros.core.model.sprite.PModelSprite;	import losrebellos.lospistoleros.data.Assets;	import losrebellos.lospistoleros.data.Content;	import losrebellos.lospistoleros.data.Fonts;	import losrebellos.lospistoleros.data.SWF;	import losrebellos.lospistoleros.data.TextFormats;	import losrebellos.lospistoleros.events.PPreloaderEvent;	import losrebellos.lospistoleros.vo.StageVO;	import flash.events.ErrorEvent;	import flash.events.Event;	import flash.events.ProgressEvent;	import flash.net.URLLoader;	import flash.net.URLLoaderDataFormat;	import flash.net.URLRequest;	/*	 *	 * @author los rebellos	 *	 */	public class PPreloaderModelSprite extends PModelSprite	{		/*		 * 		 * VARIABLES		 * 		 */				//can be overridden in case you want different params		protected var _urlAssets:String = PConstants.XML_ASSETS;		protected var _urlIndex:String = PConstants.INDEX;		protected var _stageVO:StageVO = StageVO.TOP_LEFT_NO_SCALE_BEST;		protected var _language:String = Content.DEFAULT_LANGUAGE;				//data		private var _assetsLoader:URLLoader;						/*		 * 		 * CONSTRUCTOR		 * 		 */		public function PPreloaderModelSprite(name:String = null)		{			super(name);		}				/*		 * 		 * LOAD		 * 		 */		public function load():void		{			_assetsLoader = new URLLoader;			_assetsLoader.dataFormat = URLLoaderDataFormat.TEXT;			_assetsLoader.addEventListener(ProgressEvent.PROGRESS, progressAssetsXMLHandler);			_assetsLoader.addEventListener(Event.COMPLETE, completeAssetsXMLHandler);			_assetsLoader.addEventListener(ErrorEvent.ERROR, errorHandler);			_assetsLoader.load(new URLRequest(_urlAssets));		}						/*		 * 		 * COMPLETE HANDLERS		 * 		 */		protected function completeAssetsXMLHandler(e:Event):void		{			_assetsLoader.removeEventListener(ProgressEvent.PROGRESS, progressAssetsXMLHandler);			_assetsLoader.removeEventListener(Event.COMPLETE, completeAssetsXMLHandler);			_assetsLoader.removeEventListener(ErrorEvent.ERROR, errorHandler);						Assets.instance.setXML(XML(e.target["data"]), _language);			Assets.instance.add(_urlIndex, {id: PConstants.INDEX, type: BulkLoader.TYPE_MOVIECLIP});			Assets.instance.addEventListener(BulkProgressEvent.PROGRESS, progressAssetsHandler);			Assets.instance.addEventListener(BulkLoader.COMPLETE, completeAssetsHandler);			Assets.instance.addEventListener(PPreloaderEvent.CONTENT_COMPLETE, contentCompleteHandler);			Assets.instance.addEventListener(PPreloaderEvent.FONTS_COMPLETE, fontsCompleteHandler);			Assets.instance.addEventListener(PPreloaderEvent.CSS_COMPLETE, cssCompleteHandler);			Assets.instance.addEventListener(BulkLoader.ERROR, errorHandler);			Assets.instance.start(3);		}		protected function completeAssetsHandler(e:Event):void		{			Assets.instance.removeEventListener(BulkProgressEvent.PROGRESS, progressAssetsHandler);			Assets.instance.removeEventListener(BulkLoader.COMPLETE, completeAssetsHandler);			Assets.instance.removeEventListener(PPreloaderEvent.CONTENT_COMPLETE, contentCompleteHandler);			Assets.instance.removeEventListener(PPreloaderEvent.FONTS_COMPLETE, fontsCompleteHandler);			Assets.instance.removeEventListener(PPreloaderEvent.CSS_COMPLETE, cssCompleteHandler);			Assets.instance.removeEventListener(BulkLoader.ERROR, errorHandler);						setAssets();						this.dispatchEvent(new PPreloaderEvent(PPreloaderEvent.COMPLETE));		}		protected function setAssets():void		{			Console.output(this, "You need to set your assets here");		}						/*		 * 		 * GENERAL HANDLERS		 * 		 */		protected function progressAssetsXMLHandler(e:ProgressEvent):void		{//			this.dispatchEvent(new PPreloaderEvent(PPreloaderEvent.PROGRESS, calculatePercent(e.bytesLoaded / e.bytesTotal)));		}		protected function progressAssetsHandler(e:BulkProgressEvent):void		{			this.dispatchEvent(new PPreloaderEvent(PPreloaderEvent.PROGRESS, calculatePercent(e.percentLoaded)));		}		protected function errorHandler(e:ErrorEvent):void		{			this.dispatchEvent(new PPreloaderEvent(PPreloaderEvent.ERROR));		}		protected function calculatePercent(p:Number):Number		{			return Math.round( 100 * p ) / 100;		}						/*		 * 		 * SPECIFIC ASSETS		 * 		 */		protected function fontsCompleteHandler(e:PPreloaderEvent):void		{			Assets.instance.removeEventListener(PPreloaderEvent.FONTS_COMPLETE, fontsCompleteHandler);						var tab_classes:Array = SWF.parse(Assets.instance.getByteArray(PConstants.FONTS));			Fonts.instance.register(tab_classes);			Console.output(this, "Fonts registered");		}		protected function contentCompleteHandler(e:PPreloaderEvent):void		{			Assets.instance.removeEventListener(PPreloaderEvent.CONTENT_COMPLETE, contentCompleteHandler);						Content.instance.register(Assets.instance.getXML(PConstants.CONTENT));			Console.output(this, "Content registered");		}		protected function cssCompleteHandler(e:PPreloaderEvent):void		{			Assets.instance.removeEventListener(PPreloaderEvent.CSS_COMPLETE, cssCompleteHandler);						TextFormats.instance.registerStyleSheetFromAssets(PConstants.CSS);			Console.output(this, "CSS registered");		}				/*		 * 		 * DATA		 * 		 */		public function setLanguage(_language:String):void		{			_language = _language;		}		public function getStage():StageVO		{			return _stageVO;		}		public function getMain():PApplicationSprite		{			return Assets.instance.getIndex();		}	}}